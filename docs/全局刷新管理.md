# 全局刷新管理功能

## 功能概述

右上角的刷新按钮现在是一个**万能的全局刷新控制器**，可以：

1. **触发所有页面的刷新** - 点击一次刷新按钮，所有监听的页面都会同时刷新数据
2. **取消正在进行的刷新** - 如果有刷新正在进行，再次点击刷新按钮会取消所有正在进行的刷新操作

## 使用方式

### 触发刷新
- 点击右上角的刷新图标（🔄）
- 系统会显示提示："🔄 正在刷新所有页面数据..."
- 所有已注册的页面会同时开始刷新

### 取消刷新
- 当有刷新正在进行时，刷新图标会变成关闭图标（❌）并带有脉冲动画
- 鼠标悬停会显示："取消刷新 (X 个任务进行中)"
- 点击图标会立即取消所有正在进行的刷新任务
- 系统会显示提示："🛑 已取消所有刷新任务"

## 技术实现

### 1. 全局刷新管理 Store (`stores/refresh.js`)

创建了一个 Pinia store 来管理所有刷新操作：

```javascript
// 主要功能
- registerRefresh(key)      // 注册一个刷新操作，返回 AbortController
- unregisterRefresh(key)    // 注销刷新操作
- cancelAllRefresh()        // 取消所有正在进行的刷新
- triggerGlobalRefresh()    // 触发全局刷新或取消
```

### 2. Navbar 组件更新

刷新按钮现在会：
- 根据刷新状态显示不同的图标（Refresh 或 Close）
- 显示动态的提示文本
- 在刷新时显示脉冲动画

### 3. 页面组件集成

需要支持可取消刷新的页面需要：

```javascript
import { useRefreshStore } from '@/stores/refresh';

const refreshStore = useRefreshStore();

const fetchData = async () => {
  // 1. 注册刷新操作
  const controller = refreshStore.registerRefresh('page-name');
  
  try {
    // 2. 在 API 调用中传递 signal
    const res = await getAgentList({ signal: controller.signal });
    
    // ... 处理数据
  } catch (error) {
    // 3. 检查是否是取消错误
    if (error.name === 'CanceledError' || error.name === 'AbortError') {
      console.log('刷新已取消');
      return;
    }
    // ... 处理其他错误
  } finally {
    // 4. 注销刷新操作
    refreshStore.unregisterRefresh('page-name');
  }
};

onUnmounted(() => {
  // 5. 组件卸载时清理
  refreshStore.unregisterRefresh('page-name');
});
```

### 4. API 函数更新

所有需要支持取消的 API 函数都已更新为接受配置参数：

```javascript
// 之前
export const getAgentList = () => {
  return request.get('/monitor/agents/list');
};

// 现在
export const getAgentList = (config = {}) => {
  return request.get('/monitor/agents/list', config);
};
```

## 已集成的页面

以下页面已经支持全局刷新和取消功能：

1. ✅ **监控大屏** (`MonitorDashboard.vue`)
2. ✅ **智能体列表** (`AgentList.vue`)

## 视觉反馈

### 正常状态
- 图标：🔄 (Refresh)
- 提示：刷新所有数据
- 颜色：默认灰色，悬停时变为主题色

### 刷新中状态
- 图标：❌ (Close)
- 提示：取消刷新 (X 个任务进行中)
- 颜色：错误色（红色）
- 动画：脉冲动画（放大缩小 + 透明度变化）

## 优势

1. **统一控制** - 一个按钮控制所有页面的刷新
2. **可取消** - 避免不必要的网络请求，节省资源
3. **实时反馈** - 清晰的视觉提示显示当前状态
4. **跨页面** - 即使切换页面，刷新控制依然有效
5. **优雅降级** - 如果某个页面不支持取消，不会影响其他页面

## 未来扩展

可以考虑添加：
- 刷新进度条
- 单个页面的刷新控制
- 自定义刷新间隔
- 刷新历史记录
