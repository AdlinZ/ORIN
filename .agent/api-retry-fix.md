# API请求自动重试机制修复说明

## 问题描述

用户反馈：启动系统时如果网络断开，外部API会显示error状态。即使后来网络恢复、API正常工作，刷新页面后仍然显示error。

## 问题根因

1. **无重试机制**：当首次API请求失败时（如网络断开），前端直接显示错误，不会自动重试
2. **错误状态持久化**：页面刷新时，如果初始加载请求再次失败，错误状态会继续显示
3. **网络波动敏感**：临时的网络问题（如DNS解析延迟、短暂断网）会导致永久性的错误显示

## 解决方案

在 `/orin-frontend/src/utils/request.js` 中添加了**自动重试机制**：

### 核心特性

1. **智能重试判断**
   - 网络错误 (Network Error)
   - 请求超时 (timeout)
   - 连接中断 (ECONNABORTED)
   - 服务器错误 (5xx状态码)

2. **重试配置**
   ```javascript
   const MAX_RETRIES = 2;        // 最大重试2次
   const RETRY_DELAY = 1000;     // 基础延迟1秒
   ```

3. **指数退避**
   - 第1次重试：等待 1秒
   - 第2次重试：等待 2秒
   - 避免对服务器造成压力

4. **用户体验优化**
   - 只在最后一次重试失败后才显示错误消息
   - 避免重复的错误提示干扰用户
   - 后台静默重试，用户无感知

### 代码实现

```javascript
// 判断是否应该重试
const shouldRetry = (
    error.message.includes('Network Error') || 
    error.message.includes('timeout') ||
    error.code === 'ECONNABORTED' ||
    (error.response && error.response.status >= 500)
) && config.retryCount < MAX_RETRIES;

if (shouldRetry) {
    config.retryCount += 1;
    console.log(`重试请求 (${config.retryCount}/${MAX_RETRIES}): ${config.url}`);
    
    // 等待后重试（指数退避）
    await delay(RETRY_DELAY * config.retryCount);
    
    // 重新发起请求
    return service(config);
}
```

## 修复效果

### 修复前
1. 启动时断网 → API请求失败 → 显示error
2. 连上网络 → 刷新页面 → 仍显示error（因为没有重试）
3. 用户需要手动多次刷新或清除缓存

### 修复后
1. 启动时断网 → API请求失败 → 自动重试
2. 网络恢复 → 重试成功 → 正常显示
3. 即使刷新页面，也会自动重试直到成功

## 适用场景

✅ **网络波动**：临时的网络不稳定
✅ **DNS延迟**：DNS解析暂时失败
✅ **服务启动**：后端服务正在启动中
✅ **负载均衡**：某个节点暂时不可用
✅ **超时恢复**：请求超时后自动重试

## 不会重试的情况

❌ **客户端错误** (4xx)：参数错误、权限不足等
❌ **认证失败** (401/403)：Token过期或无效
❌ **资源不存在** (404)：请求的资源不存在
❌ **业务逻辑错误**：后端返回的业务错误

这些情况下重试没有意义，会直接显示错误并停止重试。

## 测试建议

### 测试场景1：启动时断网
1. 断开网络连接
2. 启动ORIN系统：`./manage.sh restart`
3. 等待3-5秒后连接网络
4. 观察页面是否自动恢复正常

### 测试场景2：运行中断网
1. 系统正常运行
2. 断开网络连接
3. 尝试操作（如刷新页面、点击按钮）
4. 连接网络
5. 观察是否自动恢复

### 测试场景3：后端重启
1. 前端保持运行
2. 重启后端服务
3. 在后端启动过程中刷新页面
4. 观察是否等待后端就绪后自动加载

## 监控与调试

在浏览器控制台可以看到重试日志：
```
重试请求 (1/2): /api/v1/monitor/summary
重试请求 (2/2): /api/v1/monitor/summary
```

## 配置调整

如需调整重试策略，修改 `request.js` 中的常量：

```javascript
const MAX_RETRIES = 3;        // 增加到3次重试
const RETRY_DELAY = 500;      // 减少延迟到500ms
```

## 注意事项

1. **幂等性**：确保API接口是幂等的，重试不会造成副作用
2. **超时设置**：总超时时间 = 初始超时 + (重试次数 × 重试延迟)
3. **性能影响**：重试会增加响应时间，但提高了成功率

## 总结

通过添加自动重试机制，系统对网络波动的容错能力大大提升，用户体验更加流畅。即使在网络不稳定的环境下，系统也能自动恢复，无需用户手动干预。
