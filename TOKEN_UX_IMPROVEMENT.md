# ğŸ” Token è¿‡æœŸç”¨æˆ·ä½“éªŒæ”¹è¿›å®ŒæˆæŠ¥å‘Š

## ğŸ¯ é—®é¢˜æè¿°

### ç”¨æˆ·åé¦ˆ
> "ä¸å¯¹ æˆ‘çŸ¥é“ç¡®å®æ˜¯ç™»å½•è¿‡æœŸäº†ï¼Œä½†æ˜¯å‰ç«¯æ²¡æœ‰æé†’æ˜¯è¿‡æœŸäº†æ˜¯å§ å› ä¸ºæ¯æ¬¡æµ‹è¯•é‡å¯çš„æ—¶å€™éƒ½æ˜¯çœ‹èµ·æ¥å·²ç»'è‡ªåŠ¨ç™»å½•'äº† éƒ½ç»™å¿˜äº†è¿˜å¾—è¿™æ ·"

### æ ¸å¿ƒé—®é¢˜
1. **Token è¿‡æœŸåæ²¡æœ‰æ˜ç¡®æç¤º** - åªæ˜¾ç¤º"æ‹’ç»è®¿é—®"ï¼Œç”¨æˆ·ä¸çŸ¥é“æ˜¯ Token è¿‡æœŸ
2. **çœ‹èµ·æ¥"è‡ªåŠ¨ç™»å½•"** - Cookie ä¸­ä¿å­˜äº†è¿‡æœŸçš„ Tokenï¼Œé¡µé¢åˆ·æ–°åçœ‹èµ·æ¥å·²ç™»å½•
3. **æ²¡æœ‰è‡ªåŠ¨è·³è½¬** - Token è¿‡æœŸåä¸ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
4. **ç”¨æˆ·ä½“éªŒå·®** - ç”¨æˆ·éœ€è¦æ‰‹åŠ¨åˆ¤æ–­å’Œå¤„ç†

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ”¹è¿› HTTP å“åº”æ‹¦æˆªå™¨

**æ–‡ä»¶**: `src/utils/request.js`

#### ä¿®æ”¹å‰
```javascript
case 401: message = 'æœªæˆæƒï¼Œè¯·é‡æ–°ç™»å½•'; break;
case 403: message = 'æ‹’ç»è®¿é—®'; break;
// æ²¡æœ‰åç»­å¤„ç†
```

#### ä¿®æ”¹å
```javascript
case 401: 
    message = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'; 
    shouldLogout = true;  // æ ‡è®°éœ€è¦ç™»å‡º
    break;
case 403: 
    // æ™ºèƒ½åˆ¤æ–­æ˜¯ Token è¿‡æœŸè¿˜æ˜¯æƒé™ä¸è¶³
    const errorMsg = error.response.data?.message || '';
    if (errorMsg.toLowerCase().includes('token') || 
        errorMsg.toLowerCase().includes('expired') ||
        errorMsg.toLowerCase().includes('invalid')) {
        message = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
        shouldLogout = true;
    } else {
        message = 'æƒé™ä¸è¶³ï¼Œæ‹’ç»è®¿é—®';
    }
    break;

// è‡ªåŠ¨å¤„ç†ç™»å‡ºå’Œè·³è½¬
if (shouldLogout) {
    const userStore = useUserStore();
    userStore.logout();  // æ¸…é™¤ Token
    
    setTimeout(() => {
        if (window.location.pathname !== '/login') {
            window.location.href = '/login';  // è·³è½¬åˆ°ç™»å½•é¡µ
        }
    }, 1500);  // å»¶è¿Ÿ 1.5 ç§’ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
}
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… æ˜ç¡®æç¤º"ç™»å½•å·²è¿‡æœŸ"
- âœ… è‡ªåŠ¨æ¸…é™¤è¿‡æœŸçš„ Token
- âœ… è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
- âœ… æ™ºèƒ½åŒºåˆ† Token è¿‡æœŸå’Œæƒé™ä¸è¶³

### 2. åˆ›å»º JWT å·¥å…·å‡½æ•°

**æ–‡ä»¶**: `src/utils/jwt.js`ï¼ˆæ–°å»ºï¼‰

æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š
```javascript
parseJwt(token)              // è§£æ JWT Token
isTokenExpired(token)        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
getTokenRemainingTime(token) // è·å–å‰©ä½™æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
formatRemainingTime(ms)      // æ ¼å¼åŒ–ä¸ºå¯è¯»å­—ç¬¦ä¸²
isTokenExpiringSoon(token)   // æ£€æŸ¥æ˜¯å¦å³å°†è¿‡æœŸ
```

**ç”¨é€”**ï¼š
- åœ¨åº”ç”¨å¯åŠ¨æ—¶éªŒè¯ Token
- æ˜¾ç¤º Token å‰©ä½™æ—¶é—´
- æå‰è­¦å‘Šç”¨æˆ·

### 3. æ”¹è¿› User Store

**æ–‡ä»¶**: `src/stores/user.js`

#### æ·»åŠ  Token éªŒè¯é€»è¾‘

```javascript
function restoreFromCookies() {
    const savedToken = Cookies.get('orin_token')
    
    if (savedToken) {
        // æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
        if (isTokenExpired(savedToken)) {
            console.warn('Token has expired, clearing user data')
            logout() // æ¸…é™¤è¿‡æœŸçš„ Token
            return  // ä¸æ¢å¤ç”¨æˆ·ä¿¡æ¯
        }
        
        token.value = savedToken
        
        // è¾“å‡ºå‰©ä½™æ—¶é—´ï¼ˆè°ƒè¯•ç”¨ï¼‰
        const remaining = getTokenRemainingTime(savedToken)
        console.log(`Token is valid, remaining time: ${formatRemainingTime(remaining)}`)
    }
    // ...
}
```

#### æ–°å¢å·¥å…·å‡½æ•°

```javascript
isTokenValid()    // æ£€æŸ¥å½“å‰ Token æ˜¯å¦æœ‰æ•ˆ
getTokenInfo()    // è·å– Token è¯¦ç»†ä¿¡æ¯
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥ Token æ˜¯å¦è¿‡æœŸ
- âœ… è¿‡æœŸçš„ Token è‡ªåŠ¨æ¸…é™¤ï¼Œä¸ä¼š"å‡è£…ç™»å½•"
- âœ… æ§åˆ¶å°æ˜¾ç¤º Token å‰©ä½™æ—¶é—´ï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰

### 4. åˆ›å»º Token è¿‡æœŸè­¦å‘Šç»„ä»¶

**æ–‡ä»¶**: `src/components/TokenExpiryWarning.vue`ï¼ˆæ–°å»ºï¼‰

**åŠŸèƒ½**ï¼š
- æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ Token çŠ¶æ€
- å‰©ä½™æ—¶é—´ < 5 åˆ†é’Ÿæ—¶ï¼Œé¡¶éƒ¨æ˜¾ç¤ºè­¦å‘Šæ¡
- æä¾›"ç«‹å³é‡æ–°ç™»å½•"æŒ‰é’®
- Token è¿‡æœŸæ—¶è‡ªåŠ¨è·³è½¬

**ç•Œé¢æ•ˆæœ**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ ç™»å½•å³å°†è¿‡æœŸï¼ˆå‰©ä½™ 3 åˆ†é’Ÿï¼‰ï¼Œè¯·åŠæ—¶ä¿å­˜æ•°æ®  [ç«‹å³é‡æ–°ç™»å½•] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. é›†æˆåˆ°ä¸»åº”ç”¨

**æ–‡ä»¶**: `src/App.vue`

```vue
<template>
  <TokenExpiryWarning />  <!-- å…¨å±€è­¦å‘Šç»„ä»¶ -->
  <router-view />
</template>
```

## ğŸ“Š ç”¨æˆ·ä½“éªŒå¯¹æ¯”

### ä¿®æ”¹å‰ âŒ

```
1. ç”¨æˆ·åˆ·æ–°é¡µé¢
2. Cookie ä¸­æœ‰è¿‡æœŸçš„ Token
3. é¡µé¢çœ‹èµ·æ¥"å·²ç™»å½•"ï¼ˆå®é™… Token å·²è¿‡æœŸï¼‰
4. ç”¨æˆ·ç‚¹å‡»åŠŸèƒ½
5. è¯·æ±‚è¿”å› 403
6. æ˜¾ç¤º"æ‹’ç»è®¿é—®"ï¼ˆç”¨æˆ·å›°æƒ‘ï¼‰
7. ç”¨æˆ·æ‰‹åŠ¨é€€å‡ºç™»å½•
8. é‡æ–°ç™»å½•
```

### ä¿®æ”¹å âœ…

#### åœºæ™¯ 1ï¼šå¯åŠ¨æ—¶ Token å·²è¿‡æœŸ
```
1. ç”¨æˆ·åˆ·æ–°é¡µé¢
2. ç³»ç»Ÿæ£€æµ‹åˆ° Token å·²è¿‡æœŸ
3. è‡ªåŠ¨æ¸…é™¤è¿‡æœŸ Token
4. æ˜¾ç¤ºç™»å½•é¡µï¼ˆç”¨æˆ·çŸ¥é“éœ€è¦ç™»å½•ï¼‰
5. ç”¨æˆ·ç™»å½•
```

#### åœºæ™¯ 2ï¼šä½¿ç”¨ä¸­ Token è¿‡æœŸ
```
1. ç”¨æˆ·æ­£åœ¨ä½¿ç”¨ç³»ç»Ÿ
2. Token å‰©ä½™ 5 åˆ†é’Ÿæ—¶ï¼Œé¡¶éƒ¨æ˜¾ç¤ºè­¦å‘Š
   "âš ï¸ ç™»å½•å³å°†è¿‡æœŸï¼ˆå‰©ä½™ 3 åˆ†é’Ÿï¼‰ï¼Œè¯·åŠæ—¶ä¿å­˜æ•°æ®"
3. ç”¨æˆ·å¯ä»¥ï¼š
   - ç‚¹å‡»"ç«‹å³é‡æ–°ç™»å½•"
   - æˆ–ç»§ç»­ä½¿ç”¨ï¼Œç›´åˆ° Token è¿‡æœŸ
4. Token è¿‡æœŸåï¼š
   - æ˜¾ç¤º"ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"
   - è‡ªåŠ¨æ¸…é™¤ Token
   - 1.5 ç§’åè·³è½¬åˆ°ç™»å½•é¡µ
```

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### Token éªŒè¯æµç¨‹

```
åº”ç”¨å¯åŠ¨
  â†“
è¯»å– Cookie ä¸­çš„ Token
  â†“
è§£æ Tokenï¼Œæ£€æŸ¥ exp å­—æ®µ
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Token æœ‰æ•ˆ  â”‚  Token è¿‡æœŸ  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ¢å¤ç™»å½•çŠ¶æ€ â”‚  æ¸…é™¤ Token  â”‚
â”‚ æ˜¾ç¤ºå‰©ä½™æ—¶é—´ â”‚  æ˜¾ç¤ºç™»å½•é¡µ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¿è¡Œæ—¶ç›‘æ§

```
æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  â†“
è·å– Token å‰©ä½™æ—¶é—´
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  > 5 åˆ†é’Ÿ     â”‚  < 5 åˆ†é’Ÿ     â”‚   å·²è¿‡æœŸ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ­£å¸¸ä½¿ç”¨     â”‚  æ˜¾ç¤ºè­¦å‘Šæ¡   â”‚  è‡ªåŠ¨ç™»å‡º     â”‚
â”‚              â”‚  æé†’ç”¨æˆ·     â”‚  è·³è½¬ç™»å½•é¡µ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API è¯·æ±‚æ‹¦æˆª

```
å‘é€è¯·æ±‚
  â†“
æ·»åŠ  Authorization Header
  â†“
æ”¶åˆ°å“åº”
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  200 OK â”‚  401    â”‚  403    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ­£å¸¸    â”‚ Tokenè¿‡æœŸâ”‚æ£€æŸ¥åŸå›  â”‚
â”‚  è¿”å›    â”‚ è‡ªåŠ¨ç™»å‡º â”‚æ™ºèƒ½å¤„ç† â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶
1. âœ… `src/utils/jwt.js` - JWT å·¥å…·å‡½æ•°
2. âœ… `src/components/TokenExpiryWarning.vue` - è¿‡æœŸè­¦å‘Šç»„ä»¶

### ä¿®æ”¹æ–‡ä»¶
1. âœ… `src/utils/request.js` - æ”¹è¿›å“åº”æ‹¦æˆªå™¨
2. âœ… `src/stores/user.js` - æ·»åŠ  Token éªŒè¯
3. âœ… `src/App.vue` - é›†æˆè­¦å‘Šç»„ä»¶

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1ï¼šå¯åŠ¨æ—¶ Token å·²è¿‡æœŸ
1. ç™»å½•ç³»ç»Ÿ
2. ç­‰å¾… 24 å°æ—¶ï¼ˆæˆ–æ‰‹åŠ¨ä¿®æ”¹ Cookie ä¸­çš„ Tokenï¼‰
3. åˆ·æ–°é¡µé¢
4. **é¢„æœŸç»“æœ**ï¼š
   - âœ… æ§åˆ¶å°æ˜¾ç¤º "Token has expired, clearing user data"
   - âœ… è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
   - âœ… ä¸ä¼šæ˜¾ç¤º"å·²ç™»å½•"çŠ¶æ€

### æµ‹è¯•åœºæ™¯ 2ï¼šä½¿ç”¨ä¸­ Token è¿‡æœŸ
1. ç™»å½•ç³»ç»Ÿ
2. æ­£å¸¸ä½¿ç”¨
3. ç‚¹å‡»ä»»ä½•éœ€è¦è®¤è¯çš„åŠŸèƒ½
4. å¦‚æœ Token è¿‡æœŸï¼Œ**é¢„æœŸç»“æœ**ï¼š
   - âœ… æ˜¾ç¤º "ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"
   - âœ… 1.5 ç§’åè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ

### æµ‹è¯•åœºæ™¯ 3ï¼šToken å³å°†è¿‡æœŸè­¦å‘Š
1. ä¿®æ”¹ JWT è¿‡æœŸæ—¶é—´ä¸º 10 åˆ†é’Ÿï¼ˆæµ‹è¯•ç”¨ï¼‰
2. ç™»å½•ç³»ç»Ÿ
3. ç­‰å¾… 5 åˆ†é’Ÿ
4. **é¢„æœŸç»“æœ**ï¼š
   - âœ… é¡¶éƒ¨æ˜¾ç¤ºè­¦å‘Šæ¡
   - âœ… æ˜¾ç¤ºå‰©ä½™æ—¶é—´
   - âœ… å¯ä»¥ç‚¹å‡»"ç«‹å³é‡æ–°ç™»å½•"

### æµ‹è¯•åœºæ™¯ 4ï¼šæ§åˆ¶å°æ—¥å¿—
1. ç™»å½•ç³»ç»Ÿ
2. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
3. **é¢„æœŸè¾“å‡º**ï¼š
   ```
   Token is valid, remaining time: 23 å°æ—¶
   ```

## ğŸ¯ ç”¨æˆ·ä½“éªŒæ”¹è¿›æ€»ç»“

### é—®é¢˜
- âŒ Token è¿‡æœŸåçœ‹èµ·æ¥"è‡ªåŠ¨ç™»å½•"
- âŒ åªæ˜¾ç¤º"æ‹’ç»è®¿é—®"ï¼Œä¸çŸ¥é“åŸå› 
- âŒ éœ€è¦æ‰‹åŠ¨é€€å‡ºé‡æ–°ç™»å½•
- âŒ æ²¡æœ‰æå‰è­¦å‘Š

### è§£å†³
- âœ… å¯åŠ¨æ—¶è‡ªåŠ¨éªŒè¯ Tokenï¼Œè¿‡æœŸåˆ™æ¸…é™¤
- âœ… æ˜ç¡®æç¤º"ç™»å½•å·²è¿‡æœŸ"
- âœ… è‡ªåŠ¨æ¸…é™¤ Token å¹¶è·³è½¬ç™»å½•é¡µ
- âœ… æå‰ 5 åˆ†é’Ÿæ˜¾ç¤ºè­¦å‘Š
- âœ… æ§åˆ¶å°æ˜¾ç¤º Token å‰©ä½™æ—¶é—´ï¼ˆè°ƒè¯•ç”¨ï¼‰

### æ•ˆæœ
- ğŸ¯ ç”¨æˆ·ä¸ä¼šå†å›°æƒ‘ä¸ºä»€ä¹ˆ"æ‹’ç»è®¿é—®"
- ğŸ¯ ä¸ä¼šå‡ºç°"å‡ç™»å½•"çŠ¶æ€
- ğŸ¯ æœ‰å……è¶³æ—¶é—´ä¿å­˜æ•°æ®
- ğŸ¯ è‡ªåŠ¨åŒ–å¤„ç†ï¼Œå‡å°‘æ‰‹åŠ¨æ“ä½œ

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. Token è‡ªåŠ¨åˆ·æ–°
å®ç° Refresh Token æœºåˆ¶ï¼š
- Access Token: çŸ­æœŸï¼ˆ2-8 å°æ—¶ï¼‰
- Refresh Token: é•¿æœŸï¼ˆ7-30 å¤©ï¼‰
- è‡ªåŠ¨åˆ·æ–°ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥

### 2. æ´»åŠ¨æ£€æµ‹
è®°å½•ç”¨æˆ·æœ€åæ´»åŠ¨æ—¶é—´ï¼š
- é•¿æ—¶é—´ä¸æ´»åŠ¨è‡ªåŠ¨ç™»å‡º
- æ´»åŠ¨æ—¶è‡ªåŠ¨å»¶é•¿ Token

### 3. å¤šè®¾å¤‡ç®¡ç†
- é™åˆ¶åŒæ—¶ç™»å½•è®¾å¤‡æ•°
- æ˜¾ç¤ºå½“å‰ç™»å½•è®¾å¤‡åˆ—è¡¨
- è¿œç¨‹ç™»å‡ºå…¶ä»–è®¾å¤‡

### 4. å®‰å…¨å¢å¼º
- IP ç»‘å®š
- è®¾å¤‡æŒ‡çº¹
- å¼‚å¸¸ç™»å½•æ£€æµ‹

---

**æ”¹è¿›å®Œæˆæ—¶é—´**: 2026-01-15 14:07  
**æ ¸å¿ƒæ”¹è¿›**: Token è¿‡æœŸè‡ªåŠ¨æ£€æµ‹å’Œç”¨æˆ·å‹å¥½æç¤º  
**ç”¨æˆ·ä½“éªŒ**: ä»å›°æƒ‘åˆ°æ¸…æ™°ï¼Œä»æ‰‹åŠ¨åˆ°è‡ªåŠ¨
